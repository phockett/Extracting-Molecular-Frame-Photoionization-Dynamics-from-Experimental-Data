\subsubsection{Bootstrapping basics: fit results}

To fit the simulated data, a set of fitting parameters were defined in (magnitude, phase) form. In this case, the parameter set was simply defined from the input matrix elements, resulting in 6 complex radial matrix elements defining the problem (this equates to $2n$ parameters to determine in magnitude-phase form, or, if only relative phases are to be obtained, $2n-1$ parameters, where the remaining phase is defined as a reference, either pre or post fit); in general this step in the protocol may require manual configuration for the problem at hand, based on the symmetry of the system. The input matrix elements are listed in Table \ref{tab:inputMatE}; of particular note in this case is that only $l=1,3$ partial-waves are present, and the two continuum symmetries - $\sigma_u$ and $\pi_u$ - which correlate with $m=0$ and $m=\pm1$ respectively, and correspond to parallel and perpendicular polarization geometries in the molecular frame. Furthermore, the $m=\pm1$ pairs are identical in this case. Because the $l,\pm m$ indices are unique in this case, they will be used generally as short-hand labels for the matrix elements, e.g. $|1,\pm1\rangle$ corresponds to the $|\pi_u,1,\pm 1,\mp 1 \rangle$ continuum component (full matrix element), and $\phi_{1,\pm1}$ corresponds to the phase of this component.

The PEMtk fitting matrix element fitting routine makes use of the lmfit package [REF, https://lmfit.github.io/lmfit-py/, https://dx.doi.org/10.5281/zenodo.11813], which implements a range of fitting routines and options. In the current demonstration case a standard Levenberg-Marquardt minimization was used, 11 parameters were allowed to float freely (i.e. no symmetry relations were imposed a priori), and the $\phi_{1,-1}$ was set as a reference phase. To gain insight into the efficiency of the fitting routine, and the uniqueness of the fit results [REF], 1000 fits were performed on the same dataset, each seeded with randomised parameter values. This methodology amounts to a statistical sampling of the solution hyperspace, which may be expected to contain some local minima in general high-dimensional cases [REF]. Convergence criteria were set as .... Running in parallel on 20 (logical) cores of an AMD Threadripper 2950X based workstation, this required ~5GB of RAM and took on the order of 2 hours (note that the time per fit cycle had large variance, since convergence time depends on the start parameters); further benchmarks for the current codebase can be found at [REF].

TODO: add table of results and remap param names back to QNs.

Results are summarised broadly in Fig. \ref{509194}, which shows the best fit results over the fits. A few (tentative) conclusions can be quickly drawn from this:

\begin{enumerate}
\item The results appear to indicate a well-defined, single global minima was found, with $\chi^2 = 2.291\times10^{-3}$, and 203 fits (20\%) obtained this value.
\item There are additional close-lying bands with $\chi^2 < 2.3\times10^{-3}$. In the test case, 349 fits (35\%) obtained this region of the fitting space. These results may be due to local minima, or simply fits which didn't quite converge for numerical reasons (e.g. reached the upper limit of iterations in fitting protocol); identifying whether these sub-sets of parameters are significantly different is therefore required.
\item There are multiple bands of fits which converged to higher $\chi^2$; since there is a large step to the first of these ($\chi^2 = 2.312\times10^{-3}$), and they appear with much lower frequency, these are most likely indicative of local minima.

% \item Not all fits that converged - as defined by the criteria above - provided the reference matrix elements. This illustrates the importance of statistical sample of the solution hyperspace, and/or the use of further tests of the fit results [REF] in order to determine their veracity in general.
% \item In this case, the lowest $\chi^2$ does correspond to the reference matrix elements. Further, in the noise-free case, the minima found in these cases is orders of magnitude lower than the next best parameter set, although this may not hold in general depending on the quality of the data (see Sect. XX), and the complexity of the parameter-set.
% \item For the free floating parameter case, the results are shown in both raw form and with a reference phase set in Figs. XX and XX. This illustrates the phase sensitivity of the fitting, and also that this is a \textit{relative} phase. In a similar fashion to statistically sampling the parameter space with the seed parameters, allowing unconstrained parameters also helps to ensure that the full hyperspace is probed; however, it is not apparent that a viable solution set (or sets) have been found until a reference phase is set. (Similar considerations may apply to the magnitudes, depending on whether these are chosen to be normalised and/or if $\beta_{0,0}$ values are included in the fitting.)
% \item Uncertainties on the parameters here are estimated from the fit using a standard approach of testing the curvature of the $\chi^2$ hypersurface with respect to each parameter; in this case this routine is implemented by the lmfit library. Uncertainties may also be estimated by repeated fits to different sub-sets of the data - a statistical bootstrapping methodology - which is investigated in Sect. XX [TODO].
\end{enumerate}


\subsubsection{Bootstrapping basics: retrieved parameters \& fidelity}

To drill down into the results, the values and clustering of the retrieved parameter sets can be investigated, as well as the overall quality of the fitting. Fig. \ref{494229} illustrates the spread in retrieved parameters over the best fit region, and Fig. \ref{743962} shows the overall quality of the fits in this region. For the purposes of discussion, each band observed in Fig. \ref{509194} will be described as a $\chi^2$ cluster or group, assumed to equate to a viable set of retrieved parameters, and the best such set should equate to the "true" values, i.e. the photoionization matrix elements. Again, some tentative conclusions can be drawn:

\begin{enumerate}
\item The results for the magnitudes show very little difference within each $\chi^2$ cluster, and closer inspection reveals that values between clusters are typically within 5\%, with the exception of the [PU,3,1] case which shows a larger spread. This indicates a good agreement in all results.
\item The phase results broadly fall into two classes, (a) cases which show good agreement within a $\chi^2$ cluster, and (b) cases which have two values per $\chi^2$ cluster. Additionally there is a larger spread in the values between clusters in phase space, and this is again most apparent for the [PU,3,1] case, which spans the full $-\pi\leq\phi\leq\pi$ phase range. Note that there is no spread in the [PU,1,-1,1] phase parameter, this was fixed as a reference phase in the current case, with $\phi=-0.861$.
\item The well-defined grouping here indicates that the retrieved parameter sets are unique for each $\chi^2$ cluster, and each case can be regarded as a distinct, viable, parameter set to be futher investigated; a priori it is expected that the lowest $\chi^2$ should be the true result, but in practice this may not always hold depending on the data.
\item The parameters with split/pairs of values are indicative of cases where these is an insensitivity in the fit. In this case, the [PU,3,1] case shows an insensitivity to the sign of the phase, which appears as a splitting due to the $mod(\pi)$ nature of the result - although there is a slight bias in the results towards one of the pair in each case, this may be a statistical artefact [TO CHECK]. (This type of effect will be discussed further below.)
\end{enumerate}

TODO: confirm fit settings and results, discussion of phase lock to rotational wavepacket via magnitudes to add later.

To further investigate the parameter sets, a correlation pair/matrix representation can be used: for the phases, an example is shown in Fig. \ref{888108}. In this plot each parameter is shown as a function of all other parameters for each set (fit), and coloured by $\chi^2$. This results in a rather complex, but informative, representation. In this example the phases were "corrected", with the reference value set to zero in order to illustrate general trends (i.e. when an absolute reference value is not known), which results in a zero spread for this parameter (top left panel in Fig. \ref{888108}). Additionally, the ranges are wrapped to $\mod(\pi)$, keeping +ve values only. The bottom row and final column on the right of Fig. \ref{888108} show patterns of the parameters with $\chi^2$ value. Of particular note here is the curves visible in most cases, these indicate the curvature of the $\chi^2$ hypersurface with respect to the given coordinate (parameter), where a steeper curve indicates a more well-defined parameter. The remaining correlation plots indicate the spread of individual parameters (diagonal panels), and parameter-paramter correlations (off-diagonal panels). In general good clustering is observed for the lowest $\chi^2$ values (bluest points), consistent with the expectations from Fig. \ref{494229}, with more spread apparent in higher-valued results. For the phases with +/- pair splittings, for example the 2nd column in Fig. \ref{888108}, characteristic V shapes are observed, fanning out from the best-fit cluster as a function of $\chi^2$. Some outlier paramter sets can also be seen in this plot, for instance the single points visible to the top of the panels in the 2nd row of Fig. \ref{888108}.

To investigate the fidelity of the results in this test case the best parameter set(s) can be compared with the input matrix elements, results are presented in Table \ref{tab:matE}. In this comparison, uncertainties on the retrieved parameters were estimated statistically, based on the standard deviation in the best fit results; in this case it is of note that no "experimental" uncertainties were included in the fitting, so the estimates herein indicate purely the error in the retrieval procedure with noisy data (without noise, perfect results are found [REF WEBPAGE]). In general, aside from the insensitivity to the sign of the phase in some cases, the results are in general in good agreement with the input matrix elements.

\begin{itemize}
\item The final results are generally quite close to the inputs. In this case, the 10\% random noise essentially translates to a similar retrieval uncertainty in the magnitudes, although there is also a notable decrease in accuracy with the [PU,3,1] case, and significant increase in accuracy for the [SU] cases.
\item The absolute phase values appear to be quite far off in some cases, but the phase corrected values typically look quite reasonable; this is consistent with a lack of sensitivity in the test dataset to the sign of the phases (as discussed elsewhere), but the remapped phases ($0:\pi$) are generally precise. 
\begin{itemize}
\item With the exception of [SU,3,0] and [PU,1-1], all remapped parameters are within 10\% of the reference values.
\item For the [SU,3,0] it appears that the value is not well-defined in the data [TBC/tested], and is different from the reference value by $\sim\pi/4$.
\item For the [PU,1-1] the absolute error is, indeed, small, but since this is both close to zero, and should be defined as zero in the phase corrected case, the percentage error appears large, although the absolute value is close to the true value.
\end{itemize}
\item The doubly-degenerate [PU] cases are found to have approximately the same magnitudes and phases in the free fit. In this case this is expected from the input values, hence indicates a good fit result. In general, if known \textit{a priori}, such constraints can also be included in the fit, and should result in faster and more precise results where there are significant symmetry constraints on the results.
\item The differences between the data and reference values are much larger than the standard deviation of the fits. This is indicative of a good (close/singular) batch of fits, with a single global minima, but reveals that the results obtained are not perfect - as expected for noisey data. Adding more data-points to the fit, and/or using higher fidelity data would help in this case.
\item Alternative uncertainty estimations can be obtained from the individual parameter set results, based on the curvature of the $\chi^2$ hyperspace w.r.t. each parameter, or w.r.t. to all other parameters [ref thesis]. In testing, only the first approach was considered, making use of values returned by the \href{https://lmfit.github.io/lmfit-py/fitting.html#uncertainties-in-variable-parameters-and-their-correlations}{lmfit library routines [ref]} from inversion of the Hessian matrix; however, this value was not found to be useful in many cases here, with relative errors into the thousands of \%, likely due to the strongly-correlated nature of the fit. The 2nd approach has been used previously, but is significantly more time-consuming (each test value necessitates a refitting of all other parameters), hence statistical uncertainties may represent the best approach for fast and robust estimations.
\item As noted above, although noise was added to the simulated data prior to fitting, experimental/data uncertainties were not included in the fitting. In general these may be expected to be relatively small for $\beta$ parameters obtained via imaging-type experiments [ref? Thesis?], but may be significant for absolute count-rates (i.e. $\beta_{0,0}$), and consequently are expected to map to larger uncertainties in the absolute magnitudes. However, fitting to count-rate normalised data (angular distributions only) can mitigate this effect, as was explored in the original demonstration of the technique \cite{marceau2017MolecularFrameReconstruction}, which returned accurate \textit{relative} magnitudes and MFPADs.
\end{itemize}

An alternative test of fidelity can be investigated via a density matrix representation of the results, this is shown in Fig. [XX]. [TODO]





% \subsubsection{Bootstrapping basics: 10-point fit}

% As an initial test of the method, noise-free data was used, and 10 temporal points over the main revival feature were randomly selected. To fit the data, a set of fitting parameters were defined in (magnitude, phase) form. In this case, the parameter set was simply defined from the input matrix elements, including symmetry relations, resulting in 6 complex radial matrix elements defining the problem (this equates to 2n-1 parameters to determine in magnitude-phase form, where the -1 arises since the phases are relative, and one phase must be defined as a reference, either pre or post fit); in general this step in the protocol may require manual configuration for the problem at hand [MORE ON THIS? MATRIX METHOD TOO]. 

% The PEMtk fitting matrix element fitting routine wraps the lmfit package [REF, https://lmfit.github.io/lmfit-py/, https://dx.doi.org/10.5281/zenodo.11813], in this case a standard Levenberg-Marquardt minimization was used, and all (12) parameters allowed to float freely. To gain insight into the efficiency of the fitting routine, and the uniqueness of the fit results [REF], 1000 fits were performed on the same dataset, each seeded with randomised parameter values. (This methodology amounts to a statistical sampling of the solution hyperspace, which may be expected to contain some local minima in general high-dimensional cases. [REF]) Convergence criteria were set as .... Running in parallel on 20 (logical) cores of an AMD Threadripper 2950X based workstation, this required ~5GB of RAM and took on the order of 20 minutes per 100 fits (albeit with large variance, since convergence time depends on the start parameters); further benchmarks for the current codebase can be found at [REF].



% Results are summarised in Figs. XX. A few conclusions from this case study:

% \begin{enumerate}
% \item Not all fits that converged - as defined by the criteria above - provided the reference matrix elements. This illustrates the importance of statistical sample of the solution hyperspace, and/or the use of further tests of the fit results [REF] in order to determine their veracity in general.
% \item In this case, the lowest $\chi^2$ does correspond to the reference matrix elements. Further, in the noise-free case, the minima found in these cases is orders of magnitude lower than the next best parameter set, although this may not hold in general depending on the quality of the data (see Sect. XX), and the complexity of the parameter-set.
% \item For the free floating parameter case, the results are shown in both raw form and with a reference phase set in Figs. XX and XX. This illustrates the phase sensitivity of the fitting, and also that this is a \textit{relative} phase. In a similar fashion to statistically sampling the parameter space with the seed parameters, allowing unconstrained parameters also helps to ensure that the full hyperspace is probed; however, it is not apparent that a viable solution set (or sets) have been found until a reference phase is set. (Similar considerations may apply to the magnitudes, depending on whether these are chosen to be normalised and/or if $\beta_{0,0}$ values are included in the fitting.)
% \item Uncertainties on the parameters here are estimated from the fit using a standard approach of testing the curvature of the $\chi^2$ hypersurface with respect to each parameter; in this case this routine is implemented by the lmfit library. Uncertainties may also be estimated by repeated fits to different sub-sets of the data - a statistical bootstrapping methodology - which is investigated in Sect. XX [TODO].
% \end{enumerate}

% TO CONSIDER:

% - Level of detail here, words vs. just pointing at the notebook.
% - Plot style, types and export, see notes below (commented out)

% TODO: test HV HTML interactive export > Authorea, see https://holoviews.org/user_guide/Plots_and_Renderers.html

% Bokeh: https://docs.bokeh.org/en/latest/docs/user_guide/embed.html

% Authorea & Plotly: % https://support.authorea.com/en-us/article/inserting-an-interactive-figure-y32ne6/